# Proposal: Secure API Keys

## Summary

TMDB APIキーをクライアントサイドから完全に分離し、Express.jsプロキシサーバー経由で安全にアクセスできるようにする。これにより、APIキーの露出リスクを解消し、セキュリティを大幅に向上させる。

## Motivation

### 現在の問題

現在、TMDB APIキーが `script.js:9` にハードコードされており、以下の深刻なセキュリティリスクが存在します：

1. **APIキーの露出**: ブラウザの開発者ツールで誰でも簡単にAPIキーを確認できる
2. **悪用リスク**: 露出したAPIキーを第三者が取得し、レート制限を消費したり、不正利用される可能性がある
3. **キーローテーション困難**: APIキーを変更する際、JavaScriptファイルを再配布する必要があり、運用が困難

### なぜ今対処すべきか

- セキュリティベストプラクティスに準拠
- TMDB API利用規約の遵守（APIキーは適切に保護すべき）
- 将来的なプロダクション展開に向けた基盤整備
- 他の外部API（YouTube API等）を追加する際の参考実装

## Proposed Solution

Express.jsベースの軽量プロキシサーバーを導入し、以下のアーキテクチャを実装：

```
フロントエンド (client/)
    ↓ HTTP Request (/api/tmdb/*)
Express.js プロキシ (server/)
    ↓ HTTP Request (with API Key from .env)
TMDB API
```

### 主要な変更点

1. **プロキシサーバーの追加**: Express.js + dotenv + CORS
2. **環境変数管理**: `.env` ファイルでAPIキーを安全に管理
3. **フロントエンドのリファクタリング**: プロキシ経由でAPIにアクセス
4. **セキュリティ強化**: `.gitignore` で `.env` を除外

### なぜこのアプローチか

- **シンプル**: 既存のVanilla JavaScriptプロジェクトに最小限の変更で統合可能
- **汎用性**: どのホスティング環境でも動作（サーバーレス関数に依存しない）
- **拡張性**: 将来的なキャッシング、レート制限、認証機能の追加が容易
- **学習コスト低**: Express.jsは広く使われており、チームメンバーが容易に理解できる

詳細な設計判断は `design.md` を参照。

## Impact

### セキュリティ向上

- ✅ APIキーがクライアントサイドに一切露出しなくなる
- ✅ `.env` ファイルでキーを一元管理
- ✅ Git リポジトリにAPIキーがコミットされるリスクを排除

### 開発体験

- ⚠️ サーバーの起動が必要（追加の運用負荷）
- ✅ `npm run dev` で一括起動可能（セットアップは簡単）
- ✅ `.env.example` でテンプレート提供（新規開発者のオンボーディング改善）

### パフォーマンス

- ⚠️ プロキシのオーバーヘッド < 10ms（TMDB APIのレスポンスタイムが支配的）
- ➡️ エンドユーザー体験への影響は無視できるレベル

### デプロイメント

- ⚠️ Node.js環境が必要（多くのホスティングサービスで対応）
- ✅ Heroku、Render、Railway等で簡単にデプロイ可能
- ✅ ローカル開発環境と本番環境で同じコードベースが動作

## Alternatives Considered

1. **サーバーレス関数（Netlify/Vercel Functions）**
   - 利点: サーバー管理不要、自動スケーリング
   - 欠点: プラットフォーム依存、ローカル開発の複雑性
   - 不採用理由: 汎用性とシンプルさを優先

2. **Cloudflare Workers**
   - 利点: エッジでの低レイテンシー
   - 欠点: Cloudflare依存、学習コスト
   - 不採用理由: オーバースペック、シンプルさを優先

3. **環境変数のビルド時埋め込み（Vite/Parcel等）**
   - 利点: ビルドツールで環境変数を管理
   - 欠点: クライアントサイドに依然として露出、完全な解決策ではない
   - 不採用理由: セキュリティリスクが残る

詳細な比較は `design.md` を参照。

## Success Criteria

### 機能要件

- [ ] プロキシサーバー経由で全てのTMDB APIリクエストが正常に動作
- [ ] 既存の機能（映画検索、予告編再生、フィルタリング等）が全て動作
- [ ] ローカル開発環境で `npm run dev` 一つで起動可能

### セキュリティ要件

- [ ] ブラウザの開発者ツールでAPIキーが確認できない
- [ ] ソースコード内にAPIキーが一切存在しない
- [ ] `.env` ファイルがGit追跡対象外

### ドキュメント要件

- [ ] README.mdに明確なセットアップ手順が記載されている
- [ ] `.env.example` で必要な環境変数が文書化されている
- [ ] 新規開発者が30分以内に環境構築できる

## Timeline

約4.5時間の実装時間を見積もり（詳細は `tasks.md` を参照）：

1. **Week 1**: Phase 1-2（プロキシサーバーのセットアップと実装） - 1.5時間
2. **Week 1**: Phase 3（フロントエンドのリファクタリング） - 1時間
3. **Week 2**: Phase 4-5（開発体験の改善とテスト） - 1.25時間
4. **Week 2**: Phase 6（ドキュメントと最終確認） - 0.5時間

## Open Questions

1. **プロダクション環境のホスティング**: どのプラットフォームを使用する予定か？
   - 推奨: Render、Railway、Heroku（無料〜低コストで開始可能）

2. **環境変数の管理**: 本番環境でどのように `.env` を設定するか？
   - 推奨: ホスティングプラットフォームの環境変数設定機能を使用

3. **モニタリング**: プロキシサーバーのログやメトリクスをどう管理するか？
   - 初期実装: console.log（将来的にWinston等のロガー導入検討）

## Related Changes

なし（初期のセキュリティ改善）

## Reviewers

- @zrn_ns（プロジェクトオーナー）

## Status

**Proposed** - レビュー待ち
