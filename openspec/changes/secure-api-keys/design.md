# Design: API Key Security Implementation

## 問題の定義

現在、TMDB APIキーが `script.js:9` にハードコードされており、以下のセキュリティリスクが存在します：

1. **APIキーの露出**: クライアントサイドのJavaScriptに含まれるため、誰でもブラウザの開発者ツールで確認可能
2. **悪用リスク**: 露出したAPIキーを第三者が取得し、レート制限の消費や不正利用が可能
3. **キーローテーション困難**: APIキーを変更する場合、JavaScriptファイルの再配布が必要

## アーキテクチャの選択

### 検討したアプローチ

#### 1. シンプルなバックエンドプロキシ（採用）

**概要**: Express.jsを使用した軽量プロキシサーバーを導入し、APIキーをサーバーサイドで管理。

**利点**:
- ✅ APIキーが完全にサーバーサイドで保護される
- ✅ ローカル開発とプロダクション両方で同じコードベースが動作
- ✅ 既存の開発環境（Python/PHPサーバー）との共存が可能
- ✅ シンプルな構成で理解しやすい
- ✅ 将来的な機能拡張（キャッシング、レート制限等）が容易

**欠点**:
- ❌ サーバーの起動と管理が必要
- ❌ ホスティング環境にNode.js環境が必要

**実装の詳細**:
```
フロントエンド (script.js)
    ↓ HTTP Request
Express.js プロキシ (/api/tmdb/*)
    ↓ HTTP Request (with API Key)
TMDB API
```

#### 2. サーバーレス関数（検討したが不採用）

**概要**: Netlify Functions や Vercel Functions を使用。

**利点**:
- ✅ サーバー管理不要
- ✅ 自動スケーリング
- ✅ CDN統合

**欠点**:
- ❌ 特定のホスティングプラットフォームに依存
- ❌ ローカル開発時の追加セットアップが必要
- ❌ 現在の静的ホスティング要件と矛盾

**不採用理由**: プラットフォーム依存を避け、どの環境でも動作する汎用性を優先。

#### 3. Cloudflare Workers（検討したが不採用）

**概要**: エッジで動作する軽量プロキシ。

**利点**:
- ✅ 低レイテンシー
- ✅ グローバル分散

**欠点**:
- ❌ Cloudflare環境に依存
- ❌ Workers特有の制約（実行時間、メモリ等）
- ❌ 学習コストが高い

**不採用理由**: シンプルさと汎用性を優先。

## 選択したアーキテクチャの詳細

### ディレクトリ構造

```
trailer_zapper/
├── client/              # フロントエンドファイル（既存）
│   ├── index.html
│   ├── script.js
│   └── style.css
├── server/              # 新規: バックエンドプロキシ
│   ├── index.js         # Expressサーバー
│   ├── package.json     # 依存関係定義
│   └── .env.example     # 環境変数のテンプレート
├── .env                 # APIキー（.gitignoreに追加）
└── package.json         # ルートレベルのスクリプト定義
```

### APIエンドポイント設計

プロキシサーバーは以下のエンドポイントを提供：

```
GET /api/tmdb/*
```

- パス `*` 部分がTMDB APIのエンドポイントにマッピング
- クエリパラメータをそのまま転送
- サーバー側でAPIキーを自動付与

**例**:
```
フロントエンド: GET /api/tmdb/discover/movie?page=1
     ↓
プロキシ: GET https://api.themoviedb.org/3/discover/movie?api_key=xxx&page=1
```

### 環境変数管理

- `.env` ファイルでAPIキーを管理
- `dotenv` パッケージで読み込み
- `.gitignore` に `.env` を追加
- `.env.example` でテンプレートを提供

### CORS設定

開発環境での動作を保証するため、適切なCORS設定を実装：
- ローカル開発: `localhost:8000` を許可
- プロダクション: 実際のドメインを環境変数で設定

### エラーハンドリング

1. **TMDB APIエラー**: ステータスコードとエラーメッセージをそのまま返す
2. **サーバーエラー**: 500エラーと汎用メッセージを返す（詳細はログのみ）
3. **タイムアウト**: 10秒でタイムアウト

## セキュリティ考慮事項

1. **APIキーの保護**:
   - サーバーサイドの環境変数でのみ管理
   - クライアントには一切露出しない

2. **レート制限**:
   - 初期実装では導入しない
   - 将来的にexpress-rate-limitで実装可能

3. **入力検証**:
   - クエリパラメータの基本的なバリデーション
   - 悪意のあるリクエストの防止

4. **.env のGit管理**:
   - `.gitignore` に `.env` を追加
   - `.env.example` で必要な変数を文書化

## パフォーマンス考慮事項

1. **レスポンスタイム**:
   - プロキシのオーバーヘッドは最小限（< 10ms）
   - TMDB APIのレスポンスタイムが支配的

2. **キャッシング**:
   - 初期実装では導入しない
   - 将来的にRedisやメモリキャッシュで実装可能

## 移行戦略

1. **段階的な移行**:
   - Phase 1: プロキシサーバーの実装とテスト
   - Phase 2: フロントエンドのリファクタリング
   - Phase 3: 古いAPIキー呼び出しの削除

2. **後方互換性**:
   - 開発中は両方のアプローチを並行して動作可能にする
   - 完全移行後に古いコードを削除

## 代替案との比較

| 項目 | バックエンドプロキシ | サーバーレス | Cloudflare Workers |
|------|---------------------|-------------|-------------------|
| セキュリティ | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ |
| シンプルさ | ⭐⭐⭐ | ⭐⭐ | ⭐ |
| 汎用性 | ⭐⭐⭐ | ⭐ | ⭐ |
| 運用コスト | ⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ |
| 拡張性 | ⭐⭐⭐ | ⭐⭐ | ⭐⭐ |

**結論**: プロジェクトの現状（シンプルな静的アプリ）とチームのスキルセット（JavaScript）を考慮し、シンプルなバックエンドプロキシが最適。

## 今後の拡張可能性

採用したアーキテクチャは、将来的な以下の機能拡張を容易にします：

1. **キャッシング**: Redis等でTMDB APIレスポンスをキャッシュ
2. **レート制限**: ユーザーごとのリクエスト制限
3. **分析**: API使用状況のトラッキング
4. **認証**: ユーザー認証機能の追加
5. **追加API統合**: YouTube API等の他のAPIキーも同様に保護可能
